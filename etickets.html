<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>E-Ticket | EventEase</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    body {
      background: linear-gradient(rgba(0,0,0,0.75), rgba(0,0,0,0.75)), 
                  url('img/browse-bk1.jpg') center/cover no-repeat fixed;
      min-height: 100vh;
      color: #fff;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .container { max-width: 560px; }
    .progress { height: 32px; border-radius: 50px; margin-bottom: 30px; background: rgba(255,255,255,0.1); }
    .progress-bar { background: #28a745; font-weight: 600; border-radius: 50px; width: 100% !important; }

    .ticket-card {
      background: rgba(0, 0, 0, 0.88); border-radius: 24px; padding: 40px 32px;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6); backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.1);
      text-align: center;
    }

    .title { font-size: 2.1rem; font-weight: 700; color: #28a745; margin-bottom: 8px; }
    .subtitle { font-size: 1.1rem; color: #ddd; margin-bottom: 30px; }

    .info-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px dashed rgba(255,255,255,0.15); font-size: 1.05rem; }
    .info-row:last-child { border-bottom: none; }
    .info-label { color: #ccc; font-weight: 500; }
    .info-value { font-weight: 600; color: #fff; text-align: right; }

    .download-btn {
      background: #ffc107; color: #212529; border: none; font-weight: 600;
      padding: 14px 20px; border-radius: 50px; font-size: 1.1rem; width: 100%;
      margin-top: 20px;
    }

    .redirect-note { margin-top: 24px; font-size: 0.9rem; color: #aaa; }

    @media (max-width: 576px) {
      .ticket-card { margin: 20px; padding: 30px 20px; }
      .title { font-size: 1.8rem; }
    }
  </style>
</head>
<body>

<div id="header"></div>
<script>
  fetch("header.html")
    .then(r => r.text())
    .then(html => document.getElementById("header").innerHTML = html)
    .catch(() => {});
</script>

<div class="container py-4">
  <div class="progress">
    <div class="progress-bar">Step 3: E-Ticket Generated</div>
  </div>

  <div class="ticket-card">
    <h1 class="title">Congratulations!</h1>
    <p class="subtitle">Your tickets are confirmed and ready.</p>

    <div id="ticketInfo" class="mt-4"></div>

    <button id="downloadBtn" class="download-btn">
      Download E-Ticket (PDF)
    </button>

    <p class="redirect-note">
      You will be redirected in <span id="countdown">10</span> seconds...
    </p>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const params = new URLSearchParams(window.location.search);
    const user = params.get('user') || 'Guest';
    const email = params.get('email') || '';
    const event = params.get('event') || 'Unknown Event';
    const total = params.get('total') || '0';
    const seatNumbersParam = params.get('seatNumbers') || '';
    const seatNumbers = seatNumbersParam ? seatNumbersParam.split(',') : [];
    const numberOfSeats = params.get('numberOfSeats') || seatNumbers.length;
    const bookingId = params.get('bookingId') || 'EVT' + Math.floor(Math.random() * 900000 + 100000);

    const infoContainer = document.getElementById('ticketInfo');
    const info = [
      { label: 'Name', value: user },
      { label: 'Email', value: email },
      { label: 'Event', value: event },
      { label: 'Total Paid', value: `â‚¹${parseInt(total).toLocaleString()}` },
      { label: 'Number of Seats', value: numberOfSeats },
      { label: 'Seat Numbers', value: seatNumbers.join(', ') },
      { label: 'Booking ID', value: bookingId }
    ];

    info.forEach(item => {
      const div = document.createElement('div');
      div.className = 'info-row';
      div.innerHTML = `<span class="info-label">${item.label}:</span><span class="info-value">${item.value}</span>`;
      infoContainer.appendChild(div);
    });

    const { jsPDF } = window.jspdf;
    document.getElementById('downloadBtn').addEventListener('click', () => {
      const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a5' });
      doc.setFillColor(30, 30, 30); doc.rect(0, 0, 148, 210, 'F');
      doc.setTextColor(40, 167, 69); doc.setFontSize(24); doc.setFont('helvetica', 'bold');
      doc.text('E-TICKET', 74, 25, { align: 'center' });

      let y = 50;
      info.forEach(item => {
        doc.setTextColor(200, 200, 200); doc.setFont('helvetica', 'normal');
        doc.text(`${item.label}:`, 20, y);
        doc.setTextColor(255, 255, 255); doc.setFont('helvetica', 'bold');
        doc.text(item.value, 90, y);
        y += 12;
      });

      doc.setFontSize(10); doc.setTextColor(150, 150, 150);
      doc.text('Thank you for booking with EventEase!', 74, y + 20, { align: 'center' });

      doc.save(`EventEase_Ticket_${bookingId}.pdf`);
    });
    
    //for storage
    const bookingNumericId = bookingId.replace(/\D/g, '');
    fetch('bookSeat', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: `action=download&bookingId=${bookingNumericId}`
    });


    let countdown = 10;
    const countdownEl = document.getElementById('countdown');
    const timer = setInterval(() => {
      countdown--;
      countdownEl.textContent = countdown;
      if (countdown <= 0) {
        clearInterval(timer);
        window.location.href = 'contact.html';
      }
    }, 1000);
  });
</script>
</body>
</html>
