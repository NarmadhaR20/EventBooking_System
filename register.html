<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Register / Login | EventEase</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
	rel="stylesheet">
<style>
body {
	background: url('img/browse-bk1.jpg') no-repeat center center fixed;
	background-size: cover;
	color: white;
	font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.form-container {
	max-width: 500px;
	margin: 80px auto;
	padding: 50px;
	border-radius: 10px;
	background: rgba(0, 0, 0, 0.6);
}

.toggle-link {
	cursor: pointer;
	color: #ffc107;
	text-decoration: underline;
}

.form-title {
	text-align: center;
	margin-bottom: 20px;
}
</style>
</head>
<body>

	<!-- Header -->
	<div id="header"></div>
	<script>
    fetch("header.html")
      .then(res => res.text())
      .then(data => { document.getElementById("header").innerHTML = data; })
      .catch(err => console.error("Error loading header.html:", err));
  </script>

	<!-- Register Form -->
	<div id="registerForm" class="form-container">
		<h3 class="form-title">New User Registration</h3>
		<form id="registrationForm">
			<div class="mb-3">
				<label class="form-label">Full Name</label> <input type="text"
					id="regName" name="username" class="form-control" required>
			</div>
			<div class="mb-3">
				<label class="form-label">Email</label> <input type="email"
					id="regEmail" name="email" class="form-control" required>
			</div>
			<div class="mb-3">
				<label class="form-label">Password</label> <input type="password"
					id="regPassword" name="password" class="form-control" required>
			</div>
			<button type="submit" class="btn btn-warning w-100">Register</button>
			<p class="mt-3 text-center">
				Already have an account? <span class="toggle-link"
					onclick="showLogin()">Login here</span>
			</p>
		</form>
	</div>

	<!-- Login Form -->
	<div id="loginForm" class="form-container" style="display: none;">
		<h3 class="form-title">Login</h3>
		<form id="loginFormElement">
			<div class="mb-3">
				<label class="form-label">Email</label> <input type="email"
					id="loginEmail" name="email" class="form-control" required>
			</div>
			<div class="mb-3">
				<label class="form-label">Password</label> <input type="password"
					id="loginPassword" name="password" class="form-control" required>
			</div>
			<button type="submit" class="btn btn-warning w-100">Login</button>
			<p class="mt-3 text-center">
				New user? <span class="toggle-link" onclick="showRegister()">Register
					here</span>
			</p>
		</form>
	</div>

	<script>
    // Redirect if already logged in
    if (sessionStorage.getItem("userId")) {
      window.location.href = "browse.html";
    }

    function showLogin() {
      document.getElementById("registerForm").style.display = "none";
      document.getElementById("loginForm").style.display = "block";
    }

    function showRegister() {
      document.getElementById("loginForm").style.display = "none";
      document.getElementById("registerForm").style.display = "block";
    }

    // Registration
    document.getElementById("registrationForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const name = document.getElementById("regName").value.trim();
      const email = document.getElementById("regEmail").value.trim();
      const password = document.getElementById("regPassword").value.trim();
      if (!name || !email || !password) { alert("All fields are required"); return; }

      const requestBody = `action=register&username=${encodeURIComponent(name)}&email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`;

      fetch("AuthServlet", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded", "Accept": "text/plain" },
        body: requestBody
      })
      .then(res => res.text())
      .then(data => {
        alert(data);
        if (data.toLowerCase().includes("successful")) showLogin();
      })
      .catch(err => alert("Registration error: " + err.message));
    });

    // Login
    document.getElementById("loginFormElement").addEventListener("submit", function(e) {
      e.preventDefault();
      const email = document.getElementById("loginEmail").value.trim();
      const password = document.getElementById("loginPassword").value.trim();
      if (!email || !password) { alert("Both fields are required"); return; }

      fetch('AuthServlet', {
        method: 'POST',
        body: new URLSearchParams({ action: 'login', email, password })
      })
      .then(resp => resp.json())
      .then(data => {
        if (data.status === 'success') {
          sessionStorage.setItem("userId", data.user.userId);
          sessionStorage.setItem("username", data.user.username);
          sessionStorage.setItem("email", data.user.email);
          window.location.href = "browse.html";
        } else {
          alert(data.message);
        }
      })
      .catch(err => {
        console.error("Login error:", err);
        alert("Login failed. Try again.");
      });
    });
  </script>

</body>
</html>
